---
import { readdir } from "node:fs/promises";
import { join as pathJoin } from "node:path";

import SettingsLayout from "@layouts/SettingsLayout.astro";
import Dropdown from "@components/ui/Dropdown.astro";
import Input from "@components/ui/Input.astro";
import Button from "@components/ui/Button.astro";
import { type DropdownOptions } from "@utils/types";

const Themes: DropdownOptions[] = [{ name: "Default", value: "default" }];
const files = await readdir(pathJoin("src", "styles", "themes"), {
    encoding: "utf-8"
});
files.forEach((name) => {
    Themes.push({
        name: name.toLowerCase().charAt(0).toUpperCase() + name.slice(1).replace(".css", ""),
        value: name.toLowerCase().replace(".css", "")
    });
});

const ThemeModes: DropdownOptions[] = [
    { name: "Dark", value: "dark" },
    { name: "Light", value: "light" },
    { name: "System", value: "system" }
];
---
<SettingsLayout active="appearance" title="Appearance">
    <div class="w-full flex-grow flex flex-col gap-6">
        <div>
            <p class="text-sm font-medium mb-2"> Theme Mode </p>
            <p class="text-xs text-(--muted-foreground) mb-2"> Choose between light, dark, or system theme </p>
            <Dropdown id="themeModeSwitcher" options={ThemeModes} />
        </div>
        <div>
            <p class="text-sm font-medium mb-2"> Color Theme </p>
            <p class="text-xs text-(--muted-foreground) mb-2"> Choose a custom color theme </p>
            <Dropdown id="themeSwitcher" options={Themes} />
        </div>
    </div>
</SettingsLayout>

<script>
    import { Settings } from "@utils/settings";
    import { StoreManager } from "@utils/storage";

    const themes = async (settings: Settings, storage: StoreManager<"radius||settings">) => {
        const dropdown = document.getElementById("dropdownBox-themeSwitcher") as HTMLSelectElement;
        const themeModeDropdown = document.getElementById("dropdownBox-themeModeSwitcher") as HTMLSelectElement;
        
        // Set initial values
        dropdown.value = storage.getVal('theme') || 'default';
        themeModeDropdown.value = storage.getVal('themeMode') || 'dark';
        
        // Theme mode change handler
        themeModeDropdown.addEventListener("change", async () => {
            settings.themeMode(themeModeDropdown.value as 'light' | 'dark' | 'system');
        });
        
        // Custom theme change handler
        dropdown.addEventListener("change", async () => {
            settings.theme(dropdown.value);
        });
    };

    document.addEventListener("astro:page-load", async () => {
        try {
            const settings = await Settings.getInstance();
            const storageManager = new StoreManager<"radius||settings">("radius||settings");
            await themes(settings, storageManager);
        } catch (err) {
            console.log(err);
        };
    });
</script>
